version: "3.9"

services:
  shared-data-permissions:
    image: busybox:1.36
    container_name: shared-data-permissions
    restart: "no"
    command: ["sh", "-c", "chown -R 1000:1000 /data && chmod -R 775 /data"]
    volumes:
      - shared_data:/data

  n8n:
    build:
      context: ./n8n    
    container_name: nn8n
    restart: unless-stopped
    user: "1000:1000"
    ports:
      - "5678:5678"
    environment:
      - GENERIC_TIMEZONE=America/Sao_Paulo
      - TZ=America/Sao_Paulo
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_DEFAULT_LOCALE=pt-BR
      - NODE_FUNCTION_ALLOW_EXTERNAL=jsdom,@mozilla/readability,yt-channel-info
      - NODE_FUNCTION_ALLOW_BUILTIN=fs,path,os
    volumes:
      - n8n_data_transcription:/home/node/.n8n
      - shared_data:/data
    depends_on:
      shared-data-permissions:
        condition: service_completed_successfully
      whisper-worker:
        condition: service_healthy

  whisper-worker:
    build:
      context: ./whisper-worker
      dockerfile: Dockerfile
    container_name: whisper-worker
    restart: unless-stopped
    # Se estiver usando Docker Engine standalone:
    # runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - PYTHONUNBUFFERED=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - WHISPER_MODEL=medium
      - DATA_DIR=/data
      # Opcional: forneça cookies de login (para vídeos privados/idade/region)
      - YDL_COOKIEFILE=/cookies.txt
      # Opcional: proxy (se rede bloquear saída direta)
      # - YDL_PROXY=http://user:pass@host:port
      # Ajustes HTTP (se necessário)
      # - YDL_USER_AGENT=Mozilla/5.0 ...
      # - YDL_ACCEPT_LANGUAGE=en-US,en;q=0.9,pt-BR;q=0.8
      # - YDL_REFERER=https://youtube.com/
    volumes:
      - whisper_cache:/root/.cache/whisper
      - shared_data:/data
      # monte cookies se precisar (arquivo local na máquina host)
      - ./cookies.txt:/cookies.txt:ro
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    depends_on:
      shared-data-permissions:
        condition: service_completed_successfully

volumes:
  n8n_data_transcription:
  whisper_cache:
  shared_data:
